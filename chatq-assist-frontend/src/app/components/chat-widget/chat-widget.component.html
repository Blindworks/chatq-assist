<!-- Floating Chat Button -->
<button
  *ngIf="!isOpen"
  class="chat-button"
  [attr.data-theme]="theme"
  (click)="toggleWidget()"
  aria-label="Open chat">
  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
  </svg>
</button>

<!-- Chat Panel -->
<div *ngIf="isOpen" class="chat-panel" [attr.data-theme]="theme">
  <!-- Header -->
  <div class="chat-header">
    <div class="header-content">
      <h3>ChatQ Assist</h3>
      <p>How can we help you?</p>
    </div>
    <div class="header-actions">
      <button (click)="toggleTheme()" class="icon-button" aria-label="Toggle theme">
        <svg *ngIf="theme === 'light'" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
        <svg *ngIf="theme === 'dark'" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="5"></circle>
          <line x1="12" y1="1" x2="12" y2="3"></line>
          <line x1="12" y1="21" x2="12" y2="23"></line>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
          <line x1="1" y1="12" x2="3" y2="12"></line>
          <line x1="21" y1="12" x2="23" y2="12"></line>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
      </button>
      <button (click)="toggleWidget()" class="icon-button" aria-label="Close chat">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>

  <!-- Messages -->
  <div class="chat-messages">
    <div *ngIf="messages.length === 0" class="welcome-message">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
      </svg>
      <h4>Welcome to ChatQ Assist</h4>
      <p>Ask us anything about our products and services.</p>
    </div>

    <div *ngFor="let message of messages" class="message" [class.user]="message.role === 'user'">
      <div class="message-content">
        {{ message.content }}
      </div>
      <div *ngIf="message.sources && message.sources.length > 0" class="message-sources">
        <p class="sources-label">Sources:</p>
        <div *ngFor="let source of message.sources" class="source-item">
          <span class="source-type">{{ source.type }}</span>
          <a *ngIf="source.url" [href]="source.url" target="_blank">{{ source.title }}</a>
          <span *ngIf="!source.url">{{ source.title }}</span>
        </div>
      </div>
      <!-- Feedback buttons for assistant messages -->
      <div *ngIf="message.role === 'assistant' && message.id" class="message-feedback">
        <button
          class="feedback-btn"
          [class.active]="message.feedbackGiven === 'POSITIVE'"
          [disabled]="message.feedbackGiven !== null"
          (click)="giveFeedback(message, 'POSITIVE')"
          aria-label="Helpful">
          üëç
        </button>
        <button
          class="feedback-btn"
          [class.active]="message.feedbackGiven === 'NEGATIVE'"
          [disabled]="message.feedbackGiven !== null"
          (click)="giveFeedback(message, 'NEGATIVE')"
          aria-label="Not helpful">
          üëé
        </button>
      </div>
    </div>

    <div *ngIf="isLoading" class="message typing">
      <div class="typing-indicator">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </div>

  <!-- Input -->
  <div class="chat-input">
    <textarea
      [(ngModel)]="currentMessage"
      (keypress)="handleKeyPress($event)"
      placeholder="Type your message..."
      rows="1"
      [disabled]="isLoading"></textarea>
    <button
      (click)="sendMessage()"
      [disabled]="!currentMessage.trim() || isLoading"
      aria-label="Send message">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="22" y1="2" x2="11" y2="13"></line>
        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
      </svg>
    </button>
  </div>

  <!-- DSGVO Notice -->
  <div class="privacy-notice">
    <small>Your privacy matters. We process data according to GDPR.</small>
  </div>
</div>
